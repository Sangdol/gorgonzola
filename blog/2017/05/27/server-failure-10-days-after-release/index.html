<!DOCTYPE html>
<html lang="ko-kr">
<head>
    <title>이상현 IN 베를린 :: 프로젝트 출시 10일 후 새벽 4시에 발생한 장애의 원인</title>
        <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="index,follow">
    <meta name="description" content="약 3년 반 전 2013년 겨울, 맡고 있던 모바일웹 프로젝트 출시 후 문제없이 돌아가던 서버에서 10일이 지난 새벽 4시 2분에 장애가 발생했다. 별다른 로그는 없었고 단서는 문제가 발생했을 때 스크린 캡처한 404 페이지 화면밖에 없었다.">
    <meta name="twitter:title" content="프로젝트 출시 10일 후 새벽 4시에 발생한 장애의 원인" />
    <meta name="twitter:description" content="약 3년 반 전 2013년 겨울, 맡고 있던 모바일웹 프로젝트 출시 후 문제없이 돌아가던 서버에서 10일이 지난 새벽 4시 2분에 장애가 발생했다. 별다른 로그는 없었고 단서는 문제가 발생했을 때 스크린 캡처한 404 페이지 화면밖에 없었다." />
    <meta name="twitter:creator" content="@sangdolha" />
    <meta name="twitter:card" content="summary_large_image">

    
    <meta name="twitter:image" content="https://iamsang.com/social-logo.png" />

    
    <meta property="og:image" content="https://iamsang.com/social-logo.png" />


    <link rel="shortcut icon" type="image/png" href="/icon-192x192.png">
    <link rel="shortcut icon" sizes="192x192" href="/icon-192x192.png">
    <link rel="apple-touch-icon" href="/icon-192x192.png">

    <link rel="manifest" href="/site.webmanifest">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/styles/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/highlight.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', (event) => {
      document.querySelectorAll('pre code').forEach((block) => {
        hljs.highlightBlock(block);
      });
    });
    </script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,700|Ubuntu+Mono:400,400i,700,700i|Raleway:500">
    <link href="/css/normalize.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/sakura.css">
    <link href="/css/custom.css" rel="stylesheet">
    <script>(function(a,s,y,n,c,h,i,d,e){s.className+=' '+y;h.start=1*new Date;
            h.end=i=function(){s.className=s.className.replace(RegExp(' ?'+y),'')};
            (a[n]=a[n]||[]).hide=h;setTimeout(function(){i();h.end=null},c);h.timeout=c;
            })(window,document.documentElement,'async-hide','dataLayer',4000,
            {'GTM-PGRQWF8':true});
    </script>
    <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
          ga('create', 'UA-23501808-2', 'auto');
          ga('require', 'GTM-PGRQWF8');
          ga('send', 'pageview');

    </script>
    <script>
    /**
    * Function that captures a click on an outbound link in Analytics.
    * This function takes a valid URL string as an argument, and uses that URL string
    * as the event label. Setting the transport method to 'beacon' lets the hit be sent
    * using 'navigator.sendBeacon' in browser that support it.
    */
    var captureOutboundLink = function(url) {
       ga('send', 'event', 'outbound', 'click', url, {
         'transport': 'beacon'
       });
    }
    </script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
    // capturing outbound link
    $(function () {
      $('a[href^="https:"]:not(a[href^="https://' + document.location.hostname + '"])').click(function () {
        captureOutboundLink($(this).attr('href'));
      });
    });

    // new window for outbound link
    $(function () {
      $('a[href^="https:"]:not(a[href^="https://' + document.location.hostname + '"])').attr('target', '_blank');
    });

    console.log("안녕하세요, 이상현입니다. 제 블로그에 있는 html, css, js 등은 그냥 가져다 쓰셔도 됩니다. 좋은 하루 되세요.")
    </script>
</head>
<body>
    <section class="top">
        <nav>
            <a href="/"><span>글</span></a>
            <a href="/about"><span>소개</span></a>
            <a href="/popular"><span>인기글</span></a>
            <a href="/subscribe"><span>구독</span></a>
            <a href="https://twitter.com/sangdolha"><span>트위터</span></a>
        </nav>
    </section>
    <hr class="top-line">
    <section class="header">
        <div class="container">
            <div class="content">
                <a href="/">
                    <div class="name">
                        이상현
                        <span class="colored" style="font-weight:100">in</span>
                        <span style="font-weight:300">베를린</span>
                    </div>
                </a>
            </div>
        </div>
    </section>
<div class="container article">
    <div class="page-heading">프로젝트 출시 10일 후 새벽 4시에 발생한 장애의 원인</div>
    <p>2013년 겨울, 맡고 있던 모바일웹 프로젝트 출시 후 10일이 지난 새벽 4시 2분에 장애가 발생했다. 출근했을 때에는 이미 서버를 재시작하여 복구된 상태였다. 별다른 로그는 없었고 단서는 문제가 발생했을 때 스크린캡처한 <code>404 Not Found</code> 페이지 화면 밖에 없었다. 원인을 밝혀내지 않으면 언제 다시 문제가 발생할지 모르는 상황이었다.</p><p>서버 구성은 다음과 같았다.</p><ul><li>센트OS 서버 운영체제</li><li>엔진엑스 웹서버</li><li>스프링부트+제티 스탠드얼론 웹애플리케이션 서버 (이하 WAS)</li></ul><p>당시까지만 해도 스프링부트(Spring Boot)가 베타 버전이었기 때문에 많이 사용되고 있지 않았고 스탠드얼론(Standalone) WAS 서버도 흔치 않았다. 나에게는 톰캣이 익숙했지만, 당시 그래들(Gradle)에는 스탠드얼론 서버를 운용할 수 있는 임베디드 톰캣 플러그인이 없었기 때문에 제티를 선택했다.</p><p>사내에서는 처음 시도된 방식이었고 서버구조나 운용방법도 새로웠다. 설정파일 관리, 배포방식, 스태이징(Staging) 서버 관리 등 기존 구조가 가지고 있던 많은 불편한 부분들을 해소할 수 있도록 설계하였지만 그만큼 위험도 있었다.</p><p>유일한 단서인 404 페이지를 유심히 보았다. 레이아웃이 깨어져 있었다. CSS와 이미지 파일 로딩이 안 된 것이다. 404 페이지의 HTML은 엔진엑스에서 제공되고 있었고 CSS와 이미지 파일은 WAS와 함께 있었다. 서버 에러가 생긴 것이 아니고 파일이 사라진 것이다.</p><p>파일이 갑자기 왜 사라졌을까. 지금 WAS 관련 파일들이 어디에 저장되고 있지? 조사 후 <a href='https://stackoverflow.com/questions/7011940/how-to-configure-a-webapps-deployment-directory-in-jetty'>명시적으로 WAR(Web application ARchive) 파일 압축을 풀 디렉터리를 설정하지 않으면 <code>/tmp/jetty</code> 디렉토리가 선택된다는 사실을 알게되었다</a>.</p><p>그럼 센트OS에서 <code>/tmp</code> 디렉토리는 어떻게 관리되지?</p><p><a href='https://unix.stackexchange.com/a/118794/8610'>센트OS 6에서 <code>/tmp</code> 디렉토리의 10일 이상 된 파일들은 <code>tmpwatch</code> 명령어에 의해 삭제된다</a>. <a href='https://linux.die.net/man/8/tmpwatch'><code>tmpwatch</code></a>는 <code>cron.daily</code>의 일부로 들어가 있고, <a href='https://www.centos.org/docs/5/html/5.2/Deployment_Guide/s2-autotasks-cron-configuring.html'><code>/etc/crontab</code> 파일을 살펴보면</a> 다음과 같다.</p><pre><code class="bash">01 &#42; &#42; &#42; &#42; root run-parts /etc/cron.hourly
02 4 &#42; &#42; &#42; root run-parts /etc/cron.daily
22 4 &#42; &#42; 0 root run-parts /etc/cron.weekly
42 4 1 &#42; &#42; root run-parts /etc/cron.monthly
</code></pre>
</div>
    <section class="signup">
        <div class="container2">
            <!-- Begin MailChimp Signup Form -->
            <div id="mc_embed_signup">
                <form action="https://hjparenting.us17.list-manage.com/subscribe/post?u=8abdd78f471e341ecbf00840c&amp;id=423c9920d1" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
                    <div id="mc_embed_signup_scroll">

                        <div class="mc-field-group">
                            <input placeholder="이메일 주소" type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL"><input type="submit" value="블로그 구독" name="subscribe" id="mc-embedded-subscribe" class="subscribe button">
                        </div>
                        <div id="mce-responses" class="clear">
                            <div class="response" id="mce-error-response" style="display:none"></div>
                            <div class="response" id="mce-success-response" style="display:none"></div>
                        </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
                        <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_8abdd78f471e341ecbf00840c_423c9920d1" tabindex="-1" value=""></div>
                    </div>
                </form>
            </div>
        </div>
    </section>
    <section class="icons">
        <div class="container">
            <div class="content">
                <a href="//github.com/sangdol" target="_blank" rel="noopener"><img class="icon" src="/img/github.svg" alt="github" /></a>
                <a href="//stackoverflow.com/users/524588/sanghyun-lee" target="_blank" rel="noopener"><img class="icon" src="/img/stackoverflow.svg" alt="stackoverflow" /></a>
                <a href="//twitter.com/sangdolha" target="_blank" rel="noopener"><img class="icon" src="/img/twitter.svg" alt="twitter" /></a>
                <a href="//linkedin.com/in/sanghyun-lee-b1129151" target="_blank" rel="noopener"><img class="icon" src="/img/linkedin.svg" alt="linkedin" /></a>
                <a href="mailto:hammerha+iamsang-kr@gmail.com"><img class="icon" src="/img/email.svg" alt="email" /></a>
                <a href="/index.xml"><img class="icon" src="/img/rss.svg" alt="rss" /></a>
            </div>
        </div>
    </section>
</body>
</html>
